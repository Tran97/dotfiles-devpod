#!/bin/bash
set -e  # Exit on error

# Set up XDG directories
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"

# Create necessary directories
mkdir -p "$XDG_CONFIG_HOME/nixpkgs"
mkdir -p "$XDG_CONFIG_HOME/nvim"
mkdir -p "$XDG_DATA_HOME/nvim"

# Copy configurations (not symlink)
if [ -d "nvim" ]; then
    echo "Persisting nvim config..."
    cp -r nvim/* "$XDG_CONFIG_HOME/nvim/"
fi

if [ -f "config.nix" ]; then
    echo "Persisting nix config..."
    cp config.nix "$XDG_CONFIG_HOME/nixpkgs/config.nix"
fi

# Install Nix packages
echo "Installing Nix packages..."
nix-env -iA nixpkgs.myPackages

# Check for Ubuntu aarch64 and set up clangd if needed
if [ "$(uname -m)" = "aarch64" ] && grep -q "Ubuntu" /etc/os-release; then
    echo "Detected Ubuntu aarch64 - setting up clangd..."
    
    # Create clangd package directory
    mkdir -p "$XDG_DATA_HOME/nvim/mason/packages/clangd"
    
    # Create symlink for clangd in mason bin directory
    mkdir -p "$XDG_DATA_HOME/nvim/mason/bin"
    if command -v clangd >/dev/null 2>&1; then
        ln -sf "$(command -v clangd)" "$XDG_DATA_HOME/nvim/mason/bin/clangd"
        echo "Created symlink for clangd in mason bin directory"
    else
        echo "Warning: clangd not found in PATH, skipping symlink creation"
    fi
fi

# Verify installations
echo "Verifying installations..."
command -v nvim >/dev/null 2>&1 && echo "nvim installed successfully" || echo "nvim installation failed"
